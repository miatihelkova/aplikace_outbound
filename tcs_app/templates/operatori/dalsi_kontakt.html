{% extends "operatori/base_operator.html" %}

{% block title %}Kontakty{% endblock %}

{% block content %}
    <div class="d-flex justify-content-between align-items-center page-header">
        <div>
            <h1>Kontakty</h1>
            <p class="lead mb-0">Načtěte si další kontakt a zadejte výsledek hovoru.</p>
        </div>
        <div>
            {% if aktivni_filtry_text %}
                <span class="badge bg-success me-2 fs-6">Aktivní filtr: {{ aktivni_filtry_text }}</span>
            {% endif %}
            <button class="btn btn-outline-secondary" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasFilters" aria-controls="offcanvasFilters">
                <i class="bi bi-funnel"></i> Nastavit filtry
            </button>
        </div>
    </div>

    <!-- Část pro zobrazení kontaktu a formulář pro výsledek hovoru -->
    <div class="row">
        <div class="col-lg-12">
            {% if kontakt %}
                <div class="card shadow-sm">
                    <div class="card-header">
                        <h3>
                            <i class="bi bi-person-circle"></i> {{ kontakt.vorname }} {{ kontakt.nachname }}
                            {% if kontakt.vip %}<span class="badge bg-warning text-dark ms-2">VIP</span>{% endif %}
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <p><strong><i class="bi bi-telephone-fill text-success"></i> Telefon 1:</strong> {{ kontakt.telefon1 }}</p>
                                <p><strong><i class="bi bi-telephone text-secondary"></i> Telefon 2:</strong> {{ kontakt.telefon2 }}</p>
                                <p><strong><i class="bi bi-hash"></i> Zák. číslo:</strong> {{ kontakt.info_2 }}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong><i class="bi bi-calendar-event"></i> Narození:</strong> {{ kontakt.geburtsdatum|date:"d.m.Y" }}</p>
                                <p><strong><i class="bi bi-tag"></i> Kampaň:</strong> {{ kontakt.tlm_kampagne_2_zielprodukt }}</p>
                                <p><strong><i class="bi bi-geo-alt"></i> Adresa:</strong> {{ kontakt.strasse }}, {{ kontakt.plz }} {{ kontakt.ort }}</p>
                            </div>
                        </div>
                        <hr>
                        <h4><i class="bi bi-pencil-square"></i> Zadat výsledek hovoru</h4>
                        
                        <form method="post">
                            {% csrf_token %}
                            <input type="hidden" name="kontakt_id" value="{{ kontakt.id }}">
                            
                            <div class="mb-3">
                                <label for="{{ form.status.id_for_label }}" class="form-label fw-bold">{{ form.status.label }}</label>
                                {{ form.status }}
                                {% if form.status.errors %}<div class="invalid-feedback d-block">{{ form.status.errors.0 }}</div>{% endif %}
                            </div>
                            <div class="mb-3">
                                <label for="{{ form.poznamka.id_for_label }}" class="form-label fw-bold">{{ form.poznamka.label }}</label>
                                {{ form.poznamka }}
                            </div>
                            <div class="mb-3" id="planovany_hovor_div" style="display: none;">
                                <label for="{{ form.naplanovany_hovor.id_for_label }}" class="form-label fw-bold">{{ form.naplanovany_hovor.label }}</label>
                                {{ form.naplanovany_hovor }}
                            </div>

                            <button type="submit" name="save_call" class="btn btn-success btn-lg">
                                <i class="bi bi-check-circle"></i> Uložit výsledek
                            </button>
                        </form>
                    </div>
                </div>
            {% else %}
                <div class="alert alert-info text-center p-5" role="alert">
                    <h4 class="alert-heading">Vítejte v sekci Kontakty</h4>
                    <p>Pro zahájení práce klikněte na tlačítko "Načíst další kontakt".</p>
                    <hr>
                    <p class="mb-0">Pokud chcete upřesnit výběr, použijte tlačítko "Nastavit filtry" vpravo nahoře.</p>
                    <form method="post" class="mt-3">
                        {% csrf_token %}
                        <button type="submit" name="get_next" class="btn btn-primary btn-lg">
                            <i class="bi bi-arrow-down-circle"></i> Načíst první kontakt
                        </button>
                    </form>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- OFFCANVAS PANEL S FILTRY -->
    <!-- ZMĚNA: Přidán styl pro větší šířku panelu -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasFilters" aria-labelledby="offcanvasFiltersLabel" style="width: 450px;">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="offcanvasFiltersLabel"><i class="bi bi-funnel"></i> Filtry a akce</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <form method="post">
                {% csrf_token %}
                <h5 class="mb-3">Nastavení filtrů</h5>
                
                <div class="mb-3">
                    <label class="form-label">Typ filtru:</label>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="filter_type" id="filter_type_info_3" value="info_3" {% if aktivni_filtr_typ == 'info_3' %}checked{% endif %}>
                        <label class="form-check-label" for="filter_type_info_3">Přednostní číslo</label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="filter_type" id="filter_type_vratky" value="vratky" {% if aktivni_filtr_typ == 'vratky' %}checked{% endif %}>
                        <label class="form-check-label" for="filter_type_vratky">Pouze vratky</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="filter_type" id="filter_type_kampan" value="kampan" {% if aktivni_filtr_typ == 'kampan' %}checked{% endif %}>
                        <label class="form-check-label" for="filter_type_kampan">Kampaň</label>
                    </div>
                </div>

                <!-- Kontejner pro možnosti Přednostního čísla -->
                <div id="info_3_options" class="filter-options mb-3" style="display: none;">
                    <label class="form-label">Přednostní číslo (končí na):</label>
                    <div class="border rounded p-2" style="max-height: 150px; overflow-y: auto;">
                        {% for pc in prednostni_cisla %}
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="info_3_values" value="{{ pc }}" id="info3_{{ pc }}" {% if pc in aktivni_filtry.info_3 %}checked{% endif %}>
                            <label class="form-check-label" for="info3_{{ pc }}">{{ pc }}</label>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Kontejner pro možnosti Kampaně -->
                <div id="kampan_options" class="filter-options mb-3" style="display: none;">
                    <label for="kampan_value" class="form-label">Kampaň:</label>
                    <select name="kampan_value" id="kampan_value" class="form-select">
                        <option value="">-- Vyberte kampaň --</option>
                        {% for k in vsechny_kampane %}
                            <option value="{{ k }}" {% if aktivni_filtry.kampan == k %}selected{% endif %}>{{ k }}</option>
                        {% endfor %}
                    </select>
                </div>

                <hr class="mt-4">
                <!-- ZMĚNA: Nové uspořádání a vizuální oddělení tlačítek -->
                <div class="d-grid gap-2">
                    <button type="submit" name="set_filters" class="btn btn-success">Uložit filtry</button>
                    <button type="submit" name="reset_filters" class="btn btn-secondary">Zrušit filtry</button>
                </div>
                
                <hr class="my-3">

                <div class="d-grid gap-2">
                    <button type="submit" name="get_next" class="btn btn-primary btn-lg">
                        <i class="bi bi-arrow-down-circle"></i> Načíst další kontakt
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // JavaScript pro skrývání/zobrazování pole pro naplánovaný hovor
        const statusSelect = document.getElementById('id_status');
        const planovanyHovorDiv = document.getElementById('planovany_hovor_div');
        function togglePlanovanyHovor() {
            if (statusSelect && planovanyHovorDiv) {
                planovanyHovorDiv.style.display = (statusSelect.value === 'volat_pozdeji') ? 'block' : 'none';
            }
        }
        togglePlanovanyHovor();
        if (statusSelect) {
            statusSelect.addEventListener('change', togglePlanovanyHovor);
        }

        // JavaScript pro dynamické zobrazení filtrů
        const filterTypeRadios = document.querySelectorAll('input[name="filter_type"]');
        const optionContainers = document.querySelectorAll('.filter-options');

        function toggleFilterOptions() {
            let selectedType = document.querySelector('input[name="filter_type"]:checked');
            
            optionContainers.forEach(container => {
                container.style.display = 'none';
            });

            if (selectedType) {
                const targetContainer = document.getElementById(selectedType.value + '_options');
                if (targetContainer) {
                    targetContainer.style.display = 'block';
                }
            }
        }

        filterTypeRadios.forEach(radio => {
            radio.addEventListener('change', toggleFilterOptions);
        });

        toggleFilterOptions();
    });
    </script>
{% endblock %}