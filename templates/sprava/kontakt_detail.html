{% extends "sprava/base.html" %}

{% block title %}Detail kontaktu: {{ kontakt.get_full_name }}{% endblock %}

{% block content %}

<!-- Zobrazení zpráv (messages) -->
{% if messages %}
    {% for message in messages %}
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    {% endfor %}
{% endif %}

<!-- STAVOVÝ PANEL -->
<div class="card shadow-sm mb-4">
    <div class="card-body p-3">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="mb-0">{{ kontakt.get_full_name }}</h2>
                <p class="text-muted mb-0">Zákaznické číslo: <code>{{ kontakt.info_2 }}</code></p>
            </div>
            <div class="text-end">
                {% if kontakt.aktivni %}
                    <span class="badge bg-success fs-6">Aktivní</span>
                {% elif kontakt.trvale_blokovan %}
                    <span class="badge bg-dark fs-6">Trvale neaktivní</span>
                {% else %}
                    <span class="badge bg-danger fs-6">Dočasně neaktivní</span>
                    {% if kontakt.deaktivovan_do %}
                        <small class="d-block text-muted mt-1">do: {{ kontakt.deaktivovan_do|date:"d.m.Y" }}</small>
                    {% endif %}
                {% endif %}
            </div>
        </div>
    </div>
</div>


<div class="row g-4">
  <!-- LEVÝ SLOUPEC: FINÁLNÍ EDITAČNÍ FORMULÁŘ -->
  <div class="col-lg-5">
    <div class="card shadow-sm">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5><i class="bi bi-person-vcard-fill"></i> Detaily kontaktu</h5>
        <a href="{% url 'sprava:contacts_list' %}" class="btn btn-sm btn-secondary"><i class="bi bi-arrow-left-circle"></i> Zpět na seznam</a>
      </div>
      <div class="card-body">
        <form method="post">
          {% csrf_token %}
          
          <h6 class="text-muted">Osobní údaje</h6>
          <hr class="mt-0">
          <div class="row">
            <div class="col-md-6"><div class="mb-3">{{ form.vorname.label_tag }} {{ form.vorname }}</div></div>
            <div class="col-md-6"><div class="mb-3">{{ form.nachname.label_tag }} {{ form.nachname }}</div></div>
          </div>
          <div class="row">
            <div class="col-md-6"><div class="mb-3">{{ form.ansprache.label_tag }} {{ form.ansprache }}</div></div>
            <div class="col-md-6"><div class="mb-3">{{ form.titel.label_tag }} {{ form.titel }}</div></div>
          </div>
          <div class="mb-3">{{ form.geburtsdatum.label_tag }} {{ form.geburtsdatum }}</div>
          <div class="row">
            <div class="col-md-6"><div class="mb-3">{{ form.telefon1.label_tag }} {{ form.telefon1 }}</div></div>
            <div class="col-md-6"><div class="mb-3">{{ form.telefon2.label_tag }} {{ form.telefon2 }}</div></div>
          </div>

          <h6 class="text-muted mt-4">Adresa</h6>
          <hr class="mt-0">
          <div class="mb-3">{{ form.strasse.label_tag }} {{ form.strasse }}</div>
          <div class="row">
            <div class="col-md-8"><div class="mb-3">{{ form.ort.label_tag }} {{ form.ort }}</div></div>
            <div class="col-md-4"><div class="mb-3">{{ form.plz.label_tag }} {{ form.plz }}</div></div>
          </div>

          <h6 class="text-muted mt-4">Interní informace</h6>
          <hr class="mt-0">
          <div class="mb-3">
            <label for="id_info_2" class="form-label">Zákaznické číslo (nelze měnit)</label>
            <input type="text" id="id_info_2" class="form-control" value="{{ kontakt.info_2 }}" readonly>
          </div>
          <div class="row">
            <div class="col-md-6"><div class="mb-3">{{ form.info_1.label_tag }} {{ form.info_1 }}</div></div>
            <div class="col-md-6"><div class="mb-3">{{ form.info_3.label_tag }} {{ form.info_3 }}</div></div>
          </div>
          <div class="row">
            <div class="col-md-6"><div class="mb-3">{{ form.recency.label_tag }} {{ form.recency }}</div></div>
            <div class="col-md-6"><div class="mb-3">{{ form.assigned_operator.label_tag }} {{ form.assigned_operator }}</div></div>
          </div>

          <h6 class="text-muted mt-4">Stav</h6>
          <hr class="mt-0">
          <div class="form-check form-switch mb-2">{{ form.aktivni }} <label class="form-check-label" for="{{ form.aktivni.id_for_label }}">{{ form.aktivni.label }}</label></div>
          <div class="form-check form-switch mb-2">{{ form.trvale_blokovan }} <label class="form-check-label" for="{{ form.trvale_blokovan.id_for_label }}">{{ form.trvale_blokovan.label }}</label></div>
          <div class="form-check form-switch mb-3">{{ form.vip }} <label class="form-check-label" for="{{ form.vip.id_for_label }}">{{ form.vip.label }}</label></div>
          
          <button type="submit" class="btn btn-primary w-100 mt-3"><i class="bi bi-save-fill"></i> Uložit změny</button>
        </form>
      </div>
    </div>
  </div>

  <!-- PRAVÝ SLOUPEC: HISTORIE, KORESPONDENCE A VRATKY -->
  <div class="col-lg-7">
    <!-- SEKCE HISTORIE VOLÁNÍ - KOMPAKTNÍ VERZE S ROZBALOVÁNÍM -->
    <div class="card shadow-sm mb-4">
      <div class="card-header">
        <h5><i class="bi bi-clock-history"></i> Historie volání</h5>
      </div>
      <div class="card-body" style="max-height: 400px; overflow-y: auto;">
        
        <div class="mb-3 pb-2 border-bottom">
            <p class="mb-1 text-muted small">
                <strong>Přehled statusů:</strong>
                {% for status, count in status_stats.items %}
                    <span class="badge bg-light text-dark me-1 fw-normal">{{ status }}: {{ count }}x</span>
                {% empty %}
                    Žádné zaznamenané statusy.
                {% endfor %}
            </p>
        </div>

        {% if historie %}
            <!-- Zobrazení prvních 5 záznamů -->
            {% for h in historie|slice:":5" %}
            <div class="border-bottom pb-2 mb-2">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <strong class="text-primary"><i class="bi bi-person-fill"></i> {{ h.operator.get_full_name|default:h.operator.username }}</strong>
                        <span class="badge bg-secondary fw-normal ms-2">{{ h.get_status_display|default:"Nezadáno" }}</span>
                    </div>
                    <small class="text-muted text-nowrap">{{ h.datum_cas|date:"d.m.Y H:i" }}</small>
                </div>
                <div class="ps-3 pt-1 small">
                    {% if h.hodnota_objednavky %}<span class="me-3 text-success"><i class="bi bi-cart-check-fill"></i> <strong>Obj:</strong> {{ h.hodnota_objednavky }} Kč</span>{% endif %}
                    {% if h.naplanovany_hovor %}<span class="me-3 text-info"><i class="bi bi-calendar-plus-fill"></i> <strong>Odloženo:</strong> {{ h.naplanovany_hovor|date:"d.m.Y H:i" }}</span>{% endif %}
                    {% if h.poznamka %}<div class="text-muted fst-italic mt-1"><i class="bi bi-chat-left-text"></i> {{ h.poznamka|linebreaksbr }}</div>{% endif %}
                </div>
            </div>
            {% endfor %}

            <!-- Skryté záznamy (pokud jich je více než 5) -->
            {% if historie|length > 5 %}
            <div class="collapse" id="collapseHistory">
                {% for h in historie|slice:"5:" %}
                <div class="border-bottom pb-2 mb-2">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <strong class="text-primary"><i class="bi bi-person-fill"></i> {{ h.operator.get_full_name|default:h.operator.username }}</strong>
                            <span class="badge bg-secondary fw-normal ms-2">{{ h.get_status_display|default:"Nezadáno" }}</span>
                        </div>
                        <small class="text-muted text-nowrap">{{ h.datum_cas|date:"d.m.Y H:i" }}</small>
                    </div>
                    <div class="ps-3 pt-1 small">
                        {% if h.hodnota_objednavky %}<span class="me-3 text-success"><i class="bi bi-cart-check-fill"></i> <strong>Obj:</strong> {{ h.hodnota_objednavky }} Kč</span>{% endif %}
                        {% if h.naplanovany_hovor %}<span class="me-3 text-info"><i class="bi bi-calendar-plus-fill"></i> <strong>Odloženo:</strong> {{ h.naplanovany_hovor|date:"d.m.Y H:i" }}</span>{% endif %}
                        {% if h.poznamka %}<div class="text-muted fst-italic mt-1"><i class="bi bi-chat-left-text"></i> {{ h.poznamka|linebreaksbr }}</div>{% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            <!-- Tlačítko pro rozbalení -->
            <a class="btn btn-sm btn-outline-secondary mt-2 w-100" data-bs-toggle="collapse" href="#collapseHistory" role="button" aria-expanded="false" aria-controls="collapseHistory">
                Zobrazit starší historii ({{ historie|length|add:"-5" }})
            </a>
            {% endif %}

        {% else %}
          <p class="text-muted">Žádná historie volání.</p>
        {% endif %}
      </div>
    </div>

    <!-- SEKCE KORESPONDENCE -->
    <div class="card shadow-sm mb-4">
        <div class="card-header"><h5><i class="bi bi-envelope-fill"></i> Korespondence</h5></div>
        <div class="card-body"><p class="text-muted">Zde bude zobrazena historie korespondence.</p></div>
    </div>

    <!-- SEKCE: HISTORIE VRATEK -->
    <div class="card shadow-sm">
        <div class="card-header"><h5><i class="bi bi-box-seam-fill"></i> Historie vratek</h5></div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover table-sm mb-0">
                    <thead>
                        <tr>
                            <th>Datum vratky</th><th>Číslo faktury</th><th>Částka vratky</th><th>Důvod</th><th>Agent</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if vratky %}
                            {% for vratka in vratky %}
                            <tr>
                                <td>{{ vratka.datum_vratky|date:"d.m.Y" }}</td>
                                <td>{{ vratka.cislo_faktury|default:"-" }}</td>
                                <td>{{ vratka.castka_vratky }} Kč</td>
                                <td>{{ vratka.duvod|default:"-" }}</td>
                                <td>{{ vratka.agent|default:"-" }}</td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr><td colspan="5" class="text-center text-muted">Tento kontakt nemá žádné vratky.</td></tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
  </div>
</div>
{% endblock %}